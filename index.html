<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ (ë™ì  ì—°ë™)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .category-btn { transition: all 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">ì¬ê³  í˜„í™©</h1>
            <p class="text-gray-500 mt-2">ì‹œíŠ¸ ì´ë¦„: ì‚¼ì„± / ì‹ ë„-ë¯¸ë†€íƒ€ / ì œë¡ìŠ¤-ì˜¤í‚¤ / êµì„¸ë¼ / ë¸Œë¼ë”-HP-ì—¡ì†-ë ‰ìŠ¤ë§ˆí¬-ìºë…¼ / ìƒˆ ê¸°ê¸° / ì´ë‹ˆì…œí† ë„ˆ-ë°ìŠ¤í¬-íŒ©ìŠ¤-ìš©ì§€ / ì •ì°©ê¸°-í˜„ìƒê¸°-ìœ•ìŠ¤ë¶€í’ˆ</p>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ë²„íŠ¼: data-sheet ê°’ì€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ ì‹¤ì œ ì‹œíŠ¸ ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. -->
        <div class="mb-6 flex flex-wrap gap-2">
            <button onclick="changeCategory('ì‚¼ì„±')" data-sheet="ì‚¼ì„±" class="category-btn bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm">
                ì‚¼ì„±
            </button>
            <button onclick="changeCategory('ì‹ ë„-ë¯¸ë†€íƒ€')" data-sheet="ì‹ ë„-ë¯¸ë†€íƒ€" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">
                ì‹ ë„/ë¯¸ë†€íƒ€
            </button>
            <button onclick="changeCategory('ì œë¡ìŠ¤-ì˜¤í‚¤')" data-sheet="ì œë¡ìŠ¤-ì˜¤í‚¤" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">
                ì œë¡ìŠ¤/ì˜¤í‚¤
            </button>
            <button onclick="changeCategory('êµì„¸ë¼')" data-sheet="êµì„¸ë¼" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">
                êµì„¸ë¼
            </button>
            <!-- ë³€ê²½ëœ ì‹œíŠ¸ ì´ë¦„ -->
            <button onclick="changeCategory('ë¸Œë¼ë”-HP-ì—¡ì†-ë ‰ìŠ¤ë§ˆí¬-ìºë…¼')" data-sheet="ë¸Œë¼ë”-HP-ì—¡ì†-ë ‰ìŠ¤ë§ˆí¬-ìºë…¼" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">
                ë¸Œë¼ë” ì™¸
            </button>
            <button onclick="changeCategory('ìƒˆê¸°ê¸°')" data-sheet="ìƒˆê¸°ê¸°" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">
                ìƒˆ ê¸°ê¸°
            </button>
            <!-- ë³€ê²½ëœ ì‹œíŠ¸ ì´ë¦„ -->
            <button onclick="changeCategory('ì´ë‹ˆì…œí† ë„ˆ-ë°ìŠ¤í¬-íŒ©ìŠ¤-ìš©ì§€')" data-sheet="ì´ë‹ˆì…œí† ë„ˆ-ë°ìŠ¤í¬-íŒ©ìŠ¤-ìš©ì§€" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">
                ì†Œëª¨í’ˆ ì™¸
            </button>
            <!-- ë³€ê²½ëœ ì‹œíŠ¸ ì´ë¦„ -->
            <button onclick="changeCategory('ì •ì°©ê¸°-í˜„ìƒê¸°-ìœ•ìŠ¤ë¶€í’ˆ')" data-sheet="ì •ì°©ê¸°-í˜„ìƒê¸°-ìœ•ìŠ¤ë¶€í’ˆ" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">
                ë¶€í’ˆ
            </button>
        </div>
        
        <!-- ê²€ìƒ‰ í•„ë“œ -->
        <div class="mb-6">
            <input type="text" id="search-input" oninput="applyFilterAndDisplay()" placeholder="ì œí’ˆ ì½”ë“œ, ì œí’ˆëª…, ë˜ëŠ” ì ìš© ëª¨ë¸ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”..." 
                   class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition duration-150 ease-in-out">
        </div>

        <!-- ì•Œë¦¼/ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
        <div id="notification" class="hidden p-3 mb-4 rounded-lg shadow-md transition-opacity duration-300" role="alert">
            <p id="notification-text" class="font-medium"></p>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- ë¡œë”© ë° ì˜¤ë¥˜ ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="loading" class="p-8 text-center text-gray-500 hidden">
                <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4">ì¬ê³  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div id="error" class="p-8 text-center text-red-500 hidden">
                <p id="error-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ URL ë˜ëŠ” ì‹œíŠ¸ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 hidden" id="inventory-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ì œí’ˆ ì½”ë“œ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ì œí’ˆëª…</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ì ìš© ëª¨ë¸</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">í˜„ì¬ê³  (ìˆ˜ì • ê°€ëŠ¥)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body" class="bg-white divide-y divide-gray-200">
                        <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
         <footer class="text-center text-gray-500 mt-8 text-sm">
            <p>&copy; 2025 Inventory Manager. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // ğŸš¨ ì¤‘ìš”: ì—¬ê¸°ì— ë°°í¬ëœ êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfyc.../exec'; // ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ URLë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.

        let currentCategory = 'ì‚¼ì„±'; 
        let currentInventoryData = []; 
        
        const inventoryBody = document.getElementById('inventory-body');
        const inventoryTable = document.getElementById('inventory-table');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const errorText = document.getElementById('error-text');
        const notificationDiv = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');

        // í™•ì¸: window.confirm() ëŒ€ì‹  ì‚¬ìš©í•  ì»¤ìŠ¤í…€ ëª¨ë‹¬ í•¨ìˆ˜ (í˜„ì¬ëŠ” ì„ì‹œë¡œ confirmì„ ì‚¬ìš©í•©ë‹ˆë‹¤)
        function confirm(message) {
            return window.confirm(message);
        }

        /**
         * ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showNotification(message, type = 'success') {
            notificationText.textContent = message;
            notificationDiv.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            
            if (type === 'success') {
                notificationDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                notificationDiv.classList.add('bg-red-100', 'text-red-800');
            }

            // 5ì´ˆ í›„ì— ì•Œë¦¼ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                notificationDiv.classList.add('hidden');
            }, 5000);
        }

        /**
         * ê²€ìƒ‰ ì…ë ¥ì´ ë³€ê²½ë˜ê±°ë‚˜ ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í˜¸ì¶œë˜ì–´ ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ê³  í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function applyFilterAndDisplay() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const items = currentInventoryData;

            const filteredItems = items.filter(item => {
                if (!searchTerm) return true;
                
                const searchTarget = `${item.id} ${item.name} ${item.model}`.toLowerCase();
                
                return searchTarget.includes(searchTerm);
            });

            renderTable(filteredItems); 
        }
        
        /**
         * ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤. ë°ì´í„° ë¡œë”©ì„ ì‹œì‘í•©ë‹ˆë‹¤.
         */
        function changeCategory(sheetName) {
            currentCategory = sheetName;
            document.getElementById('search-input').value = ''; 
            currentInventoryData = []; 
            
            updateActiveButton(sheetName);
            fetchInventoryData(sheetName);
        }

        /**
         * êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤. (GET ìš”ì²­)
         */
        async function fetchInventoryData(sheetName) {
            inventoryTable.classList.add('hidden');
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                // Fetch ìš”ì²­ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ì„ 5íšŒë¡œ í™•ì¥í•˜ê³ , ë”œë ˆì´ë¥¼ ëŠ˜ë ¤ ì—°ê²° ì•ˆì •ì„±ì„ ë†’ì…ë‹ˆë‹¤.
                const MAX_RETRIES = 5; 
                let response;

                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        // IMPORTANT: sheetNameì— íŠ¹ìˆ˜ë¬¸ì(& ë“±)ê°€ í¬í•¨ë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì¸ì½”ë”©ì„ ì ìš©í•©ë‹ˆë‹¤.
                        const url = `${SCRIPT_URL}?sheet=${encodeURIComponent(sheetName)}`; 
                        response = await fetch(url);
                        if (response.ok) {
                            break; // ì„±ê³µí•˜ë©´ ë£¨í”„ íƒˆì¶œ
                        }
                    } catch (e) {
                        // Failed to fetch ì˜¤ë¥˜ ë°œìƒ ì‹œ ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„
                        if (i < MAX_RETRIES - 1) {
                            // 1.5ì´ˆ, 3ì´ˆ, 4.5ì´ˆ... ê°„ê²©ìœ¼ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.
                            await new Promise(resolve => setTimeout(resolve, 1500 * (i + 1))); 
                            console.warn(`Fetch failed for ${sheetName}, retrying... attempt ${i + 2}/${MAX_RETRIES}`);
                        } else {
                            throw e; // ë§ˆì§€ë§‰ ì‹œë„ì—ì„œ ì‹¤íŒ¨í•˜ë©´ ì˜¤ë¥˜ throw
                        }
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨ (HTTP ìƒíƒœ: ${response ? response.status : 'ì•Œ ìˆ˜ ì—†ìŒ'})`);
                }

                const data = await response.json();

                if(data.error){
                    throw new Error(`ì‹œíŠ¸ ì˜¤ë¥˜: ${data.error}`);
                }
                
                currentInventoryData = data; 
                applyFilterAndDisplay();

            } catch (e) {
                console.error('Fetch error:', e);
                // "Failed to fetch" ì˜¤ë¥˜ë¥¼ ì¢€ ë” ëª…í™•í•˜ê²Œ ì•ˆë‚´í•˜ê³ , ì´ ì‹œë„ íšŸìˆ˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                let errorMessage = e.message.includes('Failed to fetch') 
                    ? `ì—°ê²° ì˜¤ë¥˜: Apps Script URLì„ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ê³  ë°°í¬ ìƒíƒœ(ì•¡ì„¸ìŠ¤ ê¶Œí•œ: ëª¨ë“  ì‚¬ìš©ì)ë¥¼ ì ê²€í•´ì£¼ì„¸ìš”. ì‹œíŠ¸ ì´ë¦„ì´ '${sheetName}'ë¡œ ì •í™•í•œì§€ í™•ì¸í•´ ì£¼ì„¸ìš”. (ì´ ${MAX_RETRIES}íšŒ ì‹œë„ ì‹¤íŒ¨)`
                    : `ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}`;

                showError(errorMessage);
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        /**
         * 'ìˆ˜ì •' ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤. ì¬ê³  ì—…ë°ì´íŠ¸ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. (POST ìš”ì²­)
         */
        async function handleUpdateClick(itemId, sheetName) {
            const inputElement = document.getElementById(`stock-input-${itemId}`);
            const newStock = inputElement.value;
            
            if (isNaN(parseInt(newStock, 10)) || newStock.trim() === '') {
                showNotification('ìœ íš¨í•œ ì¬ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // Custom modal or confirmation dialog is required since window.confirm() is disallowed.
            if (!confirm(`${sheetName} ì‹œíŠ¸ì˜ ì œí’ˆì½”ë“œ ${itemId}ì˜ ì¬ê³ ë¥¼ ${newStock}ìœ¼ë¡œ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    },
                    body: JSON.stringify({
                        sheetName: sheetName,
                        itemId: itemId,
                        newStock: newStock
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    await fetchInventoryData(sheetName); 
                } else if (result.error) {
                    showNotification(result.error, 'error');
                } else {
                    throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

            } catch (e) {
                console.error('Update error:', e);
                showNotification(`ì¬ê³  ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            }
        }


        /**
         * í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ë°›ì•„ í…Œì´ë¸”ì— í‘œì‹œí•˜ëŠ” ì‹¤ì œ ë Œë”ë§ í•¨ìˆ˜
         */
        function renderTable(items) {
            inventoryBody.innerHTML = ''; 
            inventoryTable.classList.remove('hidden');

            if (items.length === 0) {
                const row = inventoryBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.className = 'px-6 py-4 text-center text-gray-500';
                cell.textContent = document.getElementById('search-input').value.trim() === '' 
                    ? 'í‘œì‹œí•  ì¬ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' 
                    : 'ê²€ìƒ‰ ê²°ê³¼ì— í•´ë‹¹í•˜ëŠ” ì¬ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
            } else {
                items.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const stock = parseInt(item.stock, 10) || 0; 
                    const statusColor = stock > 20 ? 'bg-green-100 text-green-800' : stock > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                    const statusText = stock > 20 ? 'ì •ìƒ' : stock > 0 ? 'ë¶€ì¡±' : 'í’ˆì ˆ';

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.model}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">
                            <div class="flex items-center space-x-2">
                                <input type="number" value="${stock}" data-item-id="${item.id}" id="stock-input-${item.id}"
                                    class="w-16 p-1 border border-gray-300 rounded text-center text-gray-800 focus:ring-blue-500 focus:border-blue-500" min="0">
                                <button onclick="handleUpdateClick('${item.id}', '${currentCategory}')" 
                                        class="bg-green-500 text-white p-2 rounded-md text-xs hover:bg-green-600 transition duration-150 shadow-sm whitespace-nowrap">
                                    ìˆ˜ì •
                                </button>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                    `;
                    inventoryBody.appendChild(row);
                });
            }
        }
        
        function showError(message) {
            inventoryTable.classList.add('hidden');
            errorDiv.classList.remove('hidden');
            errorText.textContent = message;
        }

        // í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateActiveButton(activeSheetName) {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(button => {
                if (button.dataset.sheet === activeSheetName) {
                    button.classList.remove('bg-gray-200', 'text-gray-700');
                    button.classList.add('bg-blue-500', 'text-white');
                } else {
                    button.classList.remove('bg-blue-500', 'text-white');
                    button.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
        }

        // í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ 'ì‚¼ì„±' ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => fetchInventoryData('ì‚¼ì„±'));
    </script>
</body>
</html>
