<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ (ì „ì›”ì¬ê³  ê¸°ë°˜ ë™ì  ê¸°ë¡)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .category-btn { transition: all 0.2s ease-in-out; }
        .table-cell-long { white-space: normal; }
        .stock-input { width: 4.5rem; }
        /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .custom-modal { z-index: 1000; background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">ì¬ê³  í˜„í™©</h1>
            <p class="text-gray-500 mt-2">í˜„ì¬ ì‹œíŠ¸: <span id="current-sheet-name" class="font-semibold text-blue-600">ì‚¼ì„±</span></p>
            <!-- ë™ì ìœ¼ë¡œ ê²°ì •ëœ ì…/ì¶œê³  ê¸°ë¡ ëŒ€ìƒ ì»¬ëŸ¼ í‘œì‹œ -->
            <div id="target-columns-info" class="mt-3 p-3 bg-blue-50 border-l-4 border-blue-500 text-blue-800 hidden">
                <p class="font-semibold">âš ï¸ ê¸°ë¡ ëŒ€ìƒ ì»¬ëŸ¼ (ì „ì›”ì¬ê³  ê¸°ì¤€):</p>
                <p class="text-sm">ì…ê³  ê¸°ë¡ ìœ„ì¹˜: <strong id="inbound-col-name" class="text-green-600"></strong></p>
                <p class="text-sm">ì¶œê³  ê¸°ë¡ ìœ„ì¹˜: <strong id="outbound-col-name" class="text-red-600"></strong></p>
            </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ë²„íŠ¼ -->
        <div class="mb-6 flex flex-wrap gap-2">
            <button onclick="changeCategory('ì‚¼ì„±')" data-sheet="ì‚¼ì„±" class="category-btn bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm">ì‚¼ì„±</button>
            <button onclick="changeCategory('ì‹ ë„-ë¯¸ë†€íƒ€')" data-sheet="ì‹ ë„-ë¯¸ë†€íƒ€" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">ì‹ ë„/ë¯¸ë†€íƒ€</button>
            <button onclick="changeCategory('ì œë¡ìŠ¤-ì˜¤í‚¤')" data-sheet="ì œë¡ìŠ¤-ì˜¤í‚¤" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">ì œë¡ìŠ¤/ì˜¤í‚¤</button>
            <button onclick="changeCategory('êµì„¸ë¼')" data-sheet="êµì„¸ë¼" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">êµì„¸ë¼</button>
            <button onclick="changeCategory('ë¸Œë¼ë”-HP-ì—¡ì†-ë ‰ìŠ¤ë§ˆí¬-ìºë…¼')" data-sheet="ë¸Œë¼ë”-HP-ì—¡ì†-ë ‰ìŠ¤ë§ˆí¬-ìºë…¼" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">ë¸Œë¼ë” ì™¸</button>
            <button onclick="changeCategory('ìƒˆê¸°ê¸°')" data-sheet="ìƒˆê¸°ê¸°" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">ìƒˆ ê¸°ê¸°</button>
            <button onclick="changeCategory('ì´ë‹ˆì…œí† ë„ˆ-ë°ìŠ¤í¬-íŒ©ìŠ¤-ìš©ì§€')" data-sheet="ì´ë‹ˆì…œí† ë„ˆ-ë°ìŠ¤í¬-íŒ©ìŠ¤-ìš©ì§€" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">ì†Œëª¨í’ˆ ì™¸</button>
            <button onclick="changeCategory('ì •ì°©ê¸°-í˜„ìƒê¸°-ìœ•ìŠ¤ë¶€í’ˆ')" data-sheet="ì •ì°©ê¸°-í˜„ìƒê¸°-ìœ•ìŠ¤ë¶€í’ˆ" class="category-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 text-sm">ë¶€í’ˆ</button>
        </div>
        
        <!-- ê²€ìƒ‰ í•„ë“œ -->
        <div class="mb-6">
            <input type="text" id="search-input" oninput="applyFilterAndDisplay()" placeholder="ê¸°ê¸°ëª… (êµ¬ë¶„), ë˜ëŠ” í† ë„ˆì´ë¦„ (ëª¨ë¸ëª…)ìœ¼ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”..." 
                   class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition duration-150 ease-in-out">
        </div>

        <!-- ì•Œë¦¼/ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
        <div id="notification" class="hidden p-3 mb-4 rounded-lg shadow-md transition-opacity duration-300" role="alert">
            <p id="notification-text" class="font-medium"></p>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- ë¡œë”© ë° ì˜¤ë¥˜ ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="loading" class="p-8 text-center text-gray-500 hidden">
                <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4">ì¬ê³  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div id="error" class="p-8 text-center text-red-500 hidden">
                <p id="error-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ URL ë˜ëŠ” ì‹œíŠ¸ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 hidden" id="inventory-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider table-cell-long">ê¸°ê¸°ëª… (êµ¬ë¶„)</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider table-cell-long">í† ë„ˆì´ë¦„ (ëª¨ë¸ëª…)</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-blue-600 uppercase tracking-wider table-cell-long">í˜„ì¬ ì¬ê³ </th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">ì…/ì¶œê³ </th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body" class="bg-white divide-y divide-gray-200">
                        <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ (Confirm ëŒ€ì²´) -->
        <div id="custom-confirm-modal" class="custom-modal fixed inset-0 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm">
                <p id="confirm-message" class="text-gray-700 mb-6 text-center text-lg font-semibold"></p>
                <div class="flex justify-around space-x-4">
                    <button id="confirm-cancel" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-150 w-full">ì·¨ì†Œ</button>
                    <button id="confirm-ok" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-150 w-full">í™•ì¸</button>
                </div>
            </div>
        </div>

        <footer class="text-center text-gray-500 mt-8 text-sm">
            <p>&copy; 2025 Inventory Manager. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // ğŸš¨ ì¤‘ìš”: ì—¬ê¸°ì— ë°°í¬ëœ êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz_uGQIxfBjNJ0NLPxWfW28xMrsz3PZdSqGQjKfu0HnFrs64QmoZ5zCBbc2dbImS4Nuqg/exec'; 

        let currentCategory = 'ì‚¼ì„±'; 
        let currentInventoryData = []; 
        let transactionCols = { inboundName: '', outboundName: '', inboundIndex: null, outboundIndex: null };
        
        const inventoryBody = document.getElementById('inventory-body');
        const inventoryTable = document.getElementById('inventory-table');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const errorText = document.getElementById('error-text');
        const notificationDiv = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');
        const currentSheetNameSpan = document.getElementById('current-sheet-name');
        
        // ë™ì  ì»¬ëŸ¼ ì •ë³´ í‘œì‹œ ìš”ì†Œ
        const targetColumnsInfoDiv = document.getElementById('target-columns-info');
        const inboundColNameSpan = document.getElementById('inbound-col-name');
        const outboundColNameSpan = document.getElementById('outbound-col-name');
        
        // ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìš”ì†Œ
        const confirmModal = document.getElementById('custom-confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmOk = document.getElementById('confirm-ok');
        const confirmCancel = document.getElementById('confirm-cancel');

        /**
         * Custom Confirm (window.confirm ëŒ€ì²´)
         */
        function customConfirm(message) {
            return new Promise(resolve => {
                confirmOk.replaceWith(confirmOk.cloneNode(true));
                confirmCancel.replaceWith(confirmCancel.cloneNode(true));
                const newConfirmOk = document.getElementById('confirm-ok');
                const newConfirmCancel = document.getElementById('confirm-cancel');

                confirmMessage.textContent = message;
                confirmModal.classList.remove('hidden');

                const handleOk = () => {
                    confirmModal.classList.add('hidden');
                    resolve(true);
                };

                const handleCancel = () => {
                    confirmModal.classList.add('hidden');
                    resolve(false);
                };

                newConfirmOk.addEventListener('click', handleOk);
                newConfirmCancel.addEventListener('click', handleCancel);
            });
        }


        /**
         * ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showNotification(message, type = 'success') {
            notificationText.textContent = message;
            notificationDiv.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            
            if (type === 'success') {
                notificationDiv.classList.add('bg-green-100', 'text-green-800');
            } else {
                notificationDiv.classList.add('bg-red-100', 'text-red-800');
            }

            setTimeout(() => {
                notificationDiv.classList.add('hidden');
            }, 5000);
        }

        /**
         * ê²€ìƒ‰ ì…ë ¥ì´ ë³€ê²½ë˜ê±°ë‚˜ ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í˜¸ì¶œë˜ì–´ ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ê³  í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function applyFilterAndDisplay() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const items = currentInventoryData;

            const filteredItems = items.filter(item => {
                if (!searchTerm) return true;
                
                const searchTarget = `${item.deviceName} ${item.tonerName}`.toLowerCase();
                
                return searchTarget.includes(searchTerm);
            });

            renderTable(filteredItems); 
        }
        
        /**
         * ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤. ë°ì´í„° ë¡œë”©ì„ ì‹œì‘í•©ë‹ˆë‹¤.
         */
        function changeCategory(sheetName) {
            currentCategory = sheetName;
            currentSheetNameSpan.textContent = sheetName;
            document.getElementById('search-input').value = ''; 
            currentInventoryData = []; 
            transactionCols = { inboundName: '', outboundName: '', inboundIndex: null, outboundIndex: null };
            
            updateActiveButton(sheetName);
            fetchInventoryData(sheetName);
        }

        /**
         * êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤. (GET ìš”ì²­)
         */
        async function fetchInventoryData(sheetName) {
            inventoryTable.classList.add('hidden');
            errorDiv.classList.add('hidden');
            targetColumnsInfoDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                const MAX_RETRIES = 5; 
                let response;

                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        const url = `${SCRIPT_URL}?sheet=${encodeURIComponent(sheetName)}`; 
                        response = await fetch(url);
                        if (response.ok) {
                            break; 
                        }
                    } catch (e) {
                        if (i < MAX_RETRIES - 1) {
                            await new Promise(resolve => setTimeout(resolve, 1500 * (i + 1))); 
                            console.warn(`Fetch failed for ${sheetName}, retrying... attempt ${i + 2}/${MAX_RETRIES}`);
                        } else {
                            throw e; 
                        }
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨ (HTTP ìƒíƒœ: ${response ? response.status : 'ì•Œ ìˆ˜ ì—†ìŒ'})`);
                }

                const data = await response.json();

                if(data.error){
                    throw new Error(`ì‹œíŠ¸ ì˜¤ë¥˜: ${data.error}`);
                }
                
                currentInventoryData = data.inventory; 
                transactionCols = data.transactionCols; // ë™ì  ì»¬ëŸ¼ ì •ë³´ ì €ì¥

                // ë™ì  ì»¬ëŸ¼ ì •ë³´ UI ì—…ë°ì´íŠ¸
                inboundColNameSpan.textContent = `${transactionCols.inboundName} (Col Index: ${transactionCols.inboundIndex})`;
                outboundColNameSpan.textContent = `${transactionCols.outboundName} (Col Index: ${transactionCols.outboundIndex})`;
                targetColumnsInfoDiv.classList.remove('hidden');


                applyFilterAndDisplay();

            } catch (e) {
                console.error('Fetch error:', e);
                let errorMessage = e.message.includes('Failed to fetch') 
                    ? `ì—°ê²° ì˜¤ë¥˜: Apps Script URLì„ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ê³  ë°°í¬ ìƒíƒœ(ì•¡ì„¸ìŠ¤ ê¶Œí•œ: ëª¨ë“  ì‚¬ìš©ì)ë¥¼ ì ê²€í•´ì£¼ì„¸ìš”. ì‹œíŠ¸ ì´ë¦„ì´ '${sheetName}'ë¡œ ì •í™•í•œì§€ í™•ì¸í•´ ì£¼ì„¸ìš”. (ì´ ${MAX_RETRIES}íšŒ ì‹œë„ ì‹¤íŒ¨)`
                    : `ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}`;

                showError(errorMessage);
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        /**
         * ì…ê³ /ì¶œê³  ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤. íŠ¸ëœì­ì…˜ ê¸°ë¡ì„ ìš”ì²­í•©ë‹ˆë‹¤. (POST ìš”ì²­)
         */
        async function handleStockChange(itemId, sheetName, type) {
            // ê±°ë˜ ëŒ€ìƒ ì»¬ëŸ¼ì´ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
            const targetColIndex = type === 'INBOUND' ? transactionCols.inboundIndex : transactionCols.outboundIndex;
            const targetColName = type === 'INBOUND' ? transactionCols.inboundName : transactionCols.outboundName;
            
            if (!targetColIndex) {
                 showNotification('ê¸°ë¡ ëŒ€ìƒ ì»¬ëŸ¼ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.', 'error');
                 return;
            }

            const amountInput = document.getElementById(`amount-input-${itemId}`);
            const amount = parseInt(amountInput.value, 10);
            
            if (isNaN(amount) || amount <= 0) {
                showNotification('ìœ íš¨í•œ ì…/ì¶œê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (1 ì´ìƒ)', 'error');
                return;
            }
            
            let actionText = type === 'INBOUND' ? 'ì…ê³ ' : 'ì¶œê³ ';
            
            const [deviceName, tonerName] = itemId.split('|');

            const confirmationMessage = `í•­ëª© (ê¸°ê¸°ëª…: ${deviceName}, í† ë„ˆ: ${tonerName})ì— ${amount}ê°œ ${actionText}ë¥¼ ì»¬ëŸ¼ [${targetColName}]ì— ê¸°ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

            // ì»¤ìŠ¤í…€ ëª¨ë‹¬ì„ ì‚¬ìš©í•˜ì—¬ í™•ì¸í•©ë‹ˆë‹¤.
            const isConfirmed = await customConfirm(confirmationMessage);
            if (!isConfirmed) {
                 return;
            }

            try {
                loadingDiv.classList.remove('hidden');

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sheetName: sheetName,
                        itemId: itemId, 
                        amount: amount, 
                        changeType: type, // 'INBOUND' ë˜ëŠ” 'OUTBOUND'
                        targetColIndex: targetColIndex // 1-based index ì „ë‹¬
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    showNotification(result.message, 'success');
                    // ì—…ë°ì´íŠ¸ ì„±ê³µ í›„ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ ì‹œíŠ¸ì—ì„œ ê³„ì‚°ëœ ìµœì‹  ì¬ê³  ê°’ì„ í™”ë©´ì— ë°˜ì˜í•©ë‹ˆë‹¤.
                    await fetchInventoryData(sheetName); 
                } else if (result.error) {
                    showNotification(result.error, 'error');
                } else {
                    throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

            } catch (e) {
                console.error('Update error:', e);
                showNotification(`ê±°ë˜ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }


        /**
         * í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ë°›ì•„ í…Œì´ë¸”ì— í‘œì‹œí•˜ëŠ” ì‹¤ì œ ë Œë”ë§ í•¨ìˆ˜
         */
        function renderTable(items) {
            inventoryBody.innerHTML = ''; 
            inventoryTable.classList.remove('hidden');

            if (items.length === 0) {
                const row = inventoryBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 4; 
                cell.className = 'px-6 py-4 text-center text-gray-500';
                cell.textContent = document.getElementById('search-input').value.trim() === '' 
                    ? 'í‘œì‹œí•  ì¬ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' 
                    : 'ê²€ìƒ‰ ê²°ê³¼ì— í•´ë‹¹í•˜ëŠ” ì¬ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
            } else {
                items.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const stock = parseInt(item.stock, 10) || 0; 
                    const threshold = parseInt(item.threshold, 10) || 0;

                    const statusColor = stock > threshold ? 'bg-green-100 text-green-800' : stock > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
                    const statusText = stock > threshold ? 'ì¶©ë¶„' : stock > 0 ? 'ê²½ê³ ' : 'í’ˆì ˆ';


                    row.innerHTML = `
                        <!-- 1. ê¸°ê¸°ëª… (êµ¬ë¶„) -->
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 table-cell-long">${item.deviceName}</td>
                        
                        <!-- 2. í† ë„ˆì´ë¦„ (ëª¨ë¸ëª…) -->
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 table-cell-long">${item.tonerName}</td>
                        
                        <!-- 3. í˜„ì¬ ì¬ê³  ê°’ (ì‹œíŠ¸ ìˆ˜ì‹ì— ì˜í•´ ê³„ì‚°ë¨) -->
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-bold text-blue-600 table-cell-long">
                            <span id="stock-value-${item.id}">${stock}</span>
                        </td>
                        
                        <!-- 4. ì…/ì¶œê³  ì…ë ¥ ë° ë²„íŠ¼ ì˜ì—­ -->
                        <td class="px-3 py-2 whitespace-nowrap text-sm">
                            <div class="flex flex-col space-y-1 items-center">
                                <input type="number" value="1" id="amount-input-${item.id}"
                                    class="stock-input p-1 border border-gray-300 rounded text-center text-gray-800 focus:ring-blue-500 focus:border-blue-500" min="1">
                                <div class="flex gap-1">
                                    <button onclick="handleStockChange('${item.id}', '${currentCategory}', 'INBOUND')" 
                                            class="bg-green-500 text-white p-1 rounded-md text-xs hover:bg-green-600 transition duration-150 shadow-sm whitespace-nowrap">
                                        ì…ê³  (${transactionCols.inboundName || 'Col?'})
                                    </button>
                                    <button onclick="handleStockChange('${item.id}', '${currentCategory}', 'OUTBOUND')" 
                                            class="bg-red-500 text-white p-1 rounded-md text-xs hover:bg-red-600 transition duration-150 shadow-sm whitespace-nowrap">
                                        ì¶œê³  (${transactionCols.outboundName || 'Col?'})
                                    </button>
                                </div>
                                <span class="px-2 py-0.5 text-xs leading-5 font-semibold rounded-full text-center ${statusColor}">
                                    ${statusText}
                                </span>
                            </div>
                        </td>
                    `;
                    inventoryBody.appendChild(row);
                });
            }
        }
        
        function showError(message) {
            inventoryTable.classList.add('hidden');
            errorDiv.classList.remove('hidden');
            targetColumnsInfoDiv.classList.add('hidden');
            
            // í—¤ë” ê´€ë ¨ ì˜¤ë¥˜ì¸ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ë” ëª…í™•í•œ ì•ˆë‚´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
            if (message.includes('í•„ìˆ˜ í—¤ë”') || message.includes('ì „ì›”ì¬ê³ ')) {
                 errorText.innerHTML = message + 
                     `<br><br>
                     <strong>ì‹œíŠ¸ í™•ì¸ ì‚¬í•­:</strong>
                     <ol class="list-decimal list-inside text-left mx-auto max-w-sm mt-2">
                        <li><strong>1. í•„ìˆ˜ í—¤ë”:</strong> 'êµ¬ë¶„', 'ëª¨ë¸ëª…', 'ì „ì›”ì¬ê³ ', 'í˜„ì¬ì¬ê³ 'ì˜ ì´ë¦„ê³¼ ë„ì–´ì“°ê¸°ê°€ ì‹œíŠ¸ì™€ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</li>
                        <li><strong>2. ë™ì  ì»¬ëŸ¼:</strong> 'ì „ì›”ì¬ê³ ' í—¤ë”ê°€ ì‹œíŠ¸ì— ì¡´ì¬í•˜ê³ , ê·¸ ë°”ë¡œ ì• ë‘ ì»¬ëŸ¼(ì…ê³ /ì¶œê³  ê¸°ë¡ ëŒ€ìƒ)ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.</li>
                        <li><strong>3. Apps Script URL:</strong> URLì´ ì˜¬ë°”ë¥´ê²Œ ë°°í¬ë˜ì—ˆëŠ”ì§€(ì•¡ì„¸ìŠ¤ ê¶Œí•œ: ëª¨ë“  ì‚¬ìš©ì) ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ ì£¼ì„¸ìš”.</li>
                     </ol>`;
            } else {
                 errorText.textContent = message;
            }
        }

        // í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateActiveButton(activeSheetName) {
            const buttons = document.querySelectorAll('.category-btn');
            buttons.forEach(button => {
                if (button.dataset.sheet === activeSheetName) {
                    button.classList.remove('bg-gray-200', 'text-gray-700');
                    button.classList.add('bg-blue-500', 'text-white');
                } else {
                    button.classList.remove('bg-blue-500', 'text-white');
                    button.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
        }

        // í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ 'ì‚¼ì„±' ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => fetchInventoryData('ì‚¼ì„±'));
    </script>
</body>
</html>
